<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>password</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poor+Story&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CSS/header_footer.css">
    <link rel="stylesheet" href="CSS/password.css">

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <style>
        /* 모달 오버레이 및 모달 스타일 */
        #modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        #modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1100;
        }
    </style>
</head>

<body>

    <!-- header -->
    <header>
        <div class="header-container">
            <!-- logo -->
            <div class="logo">
                <a href="메인.html"><img src="images/맛zip.png" alt="맛.zip 로고"></a>
            </div>

            <!-- search -->
            <div class="search-container">
                <div class="search-word">
                    <input type="text" placeholder="검색어를 입력하세요...">
                </div>

                <div class="popular-searches">
                    <span>인기검색어1</span>
                    <span>인기검색어2</span>
                    <span>인기검색어3</span>
                    <span>인기검색어4</span>
                    <span>인기검색어5</span>
                    <a href="" class="nearby">가까운 곳 찾기</a>
                    <a href="" class="game">
                        <img id="game" src="images/gamepad-icon.png" alt="게임패드"></a>
                </div>

            </div>

            <!-- menu -->
            <div class="menu">
                <a href="로그인.html" class="login">로그인</a>
                <a href="회원가입.html" class="signup">회원가입</a>
                <button class="menu-btn">
                    <img src="images/menu-icon.png" alt="마이페이지">
                </button>
            </div>
        </div>
    </header>

    <!-- main -->
    <div class="main-container">
        <!-- 비밀번호 찾기 섹션 -->
        <section class="password_search">
            <h2>비밀번호 찾기</h2>
            <!-- 본인 확인 폼 -->
            <form id="verifyForm">
                <!-- 이름 -->
                <input id="name" name="name" placeholder="이름" required>
                <!-- 아이디 (userId) -->
                <input id="userId" name="userId" placeholder="아이디" required>
                <!-- 보안 질문 -->
                <label for="passwordQuestion">회원가입 시 선택한 질문: </label>
                <select id="passwordQuestion" name="passwordQuestion" required>
                    <option value="당신의 초등학교는?">당신의 초등학교는?</option>
                    <option value="내가 좋아하는 음식 이름은?">내가 좋아하는 음식 이름은?</option>
                    <option value="내가 다니던 학교 이름은?">내가 다니던 학교 이름은?</option>
                    <option value="내가 가본 나라 이름은?">내가 가본 나라 이름은?</option>
                    <option value="내가 좋아하는 동물의 종류는?">내가 좋아하는 동물의 종류는?</option>
                    <option value="내가 아끼는 보물 1호는?">내가 아끼는 보물 1호는?</option>
                    <option value="나의 취미는?">나의 취미는?</option>
                    <option value="내가 좋아하는 음악은?">내가 좋아하는 음악은?</option>
                    <option value="내가 좋아하는 영화는?">내가 좋아하는 영화는?</option>
                    <option value="내가 좋아하는 가수는?">내가 좋아하는 가수는?</option>
                </select>
                <!-- 보안 답변 -->
                <input id="passwordAnswer" name="passwordAnswer" placeholder="비밀번호찾기답" required>
                <!-- 본인 확인 버튼 (페이지 내 처리) -->
                <button type="button" class="password_button" onclick="verifyUser()">본인 확인</button>
            </form>
            <!-- 본인 확인 결과 메시지를 페이지 내에 표시 -->
            <div id="verificationMessage"></div>
        </section>
    </div>

    <!-- 모달 오버레이 및 모달 (비밀번호 재설정용) -->
    <div id="modal-overlay"></div>
    <div id="modal">
        <div id="modal-content"></div>
        <button type="button" onclick="closeModal()">닫기</button>
    </div>

    <!-- footer -->
    <footer>
        <div class="footer-container">
            <p>Copyright 2025 맛zip All Right Reserved</p>
            <ul class="footer-menu">
                <li><a href="#">공지사항</a></li>
                <li><a href="#">FAQ</a></li>
                <li><a href="#">Q&A</a></li>
            </ul>
        </div>
    </footer>

    <!-- JavaScript: AJAX 요청 및 모달 처리 -->
    <script>
        // 본인 확인 요청
        function verifyUser() {
            const form = document.getElementById('verifyForm');
            const formData = new FormData(form);

            // // CSRF 토큰을 메타 태그에서 가져오기
            // const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            // const headerName = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            // CSRF 토큰과 헤더 이름을 메타 태그에서 가져오기
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const headerName = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch('/checkUserInfo', {
                method: 'POST',
                body: formData,
                headers: {
                    [headerName]: token  // ← 여기서 토큰을 헤더에 담는다
                }
            })
                .then(response => response.json())
                .then(data => {
                    const messageDiv = document.getElementById('verificationMessage');
                    if (data.Success) {
                        // 본인 확인 성공 시 모달창에 비밀번호 재설정 폼 표시
                        messageDiv.innerHTML = "";
                        const modalContent = document.getElementById('modal-content');
                        modalContent.innerHTML = `
            <p>본인 확인 성공! 새 비밀번호를 입력해주세요.</p>
            <input type="hidden" id="userType" value="${data.type}" />
            <input type="hidden" id="foundUserId" value="${data.userid}" />
            <label>새 비밀번호: <input type="password" id="newPassword" required /></label>
            <button type="button" onclick="resetPassword()">비밀번호 재설정</button>
          `;
                        openModal();
                    } else {
                        // 실패 시 메시지 표시
                        messageDiv.innerHTML = `<p style="color:red;">${data.message}</p>`;
                    }
                })
                .catch(error => console.error("Error:", error));
        }

        // 비밀번호 재설정 요청
        function resetPassword() {
            const type = document.getElementById('userType').value;
            const userId = document.getElementById('foundUserId').value;
            const newPassword = document.getElementById('newPassword').value;

            const formData = new FormData();
            formData.append('type', type);
            formData.append('userId', userId);
            formData.append('newPassword', newPassword);

            // CSRF 토큰과 헤더 이름 재사용
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const headerName = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch('/resetPassword', {
                method: 'POST',
                body: formData,
                headers: {
                    [headerName]: token  // CSRF 토큰을 헤더에 담음
                }
            })
                .then(response => response.json())
                .then(data => {
                    const modalContent = document.getElementById('modal-content');
                    const color = data.Success ? "green" : "red";
                    modalContent.innerHTML = `<p style="color:${color};">${data.message}</p>`;
                })
                .catch(error => console.error("Error:", error));
        }

        // 모달 열기 함수
        function openModal() {
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('modal').style.display = 'block';
        }

        // 모달 닫기 함수
        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('modal').style.display = 'none';
        }
    </script>
</body>
</html>